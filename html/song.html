<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Funky Friday List — Song</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* Page-specific tweaks */
    .song-header { padding: 1rem 0; text-align: center; }
    .song-meta { display:flex; gap:1rem; align-items:center; justify-content:center; flex-wrap:wrap; margin-bottom:1rem; }
    .song-meta .meta-item { color:var(--muted); font-size:.95rem; }
    .submissions-table { width:100%; border-collapse:collapse; margin-top:1rem; }
    .submissions-table th, .submissions-table td { padding:.6rem .75rem; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left; font-size:.95rem; }
    .submissions-table th { color:var(--muted); font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.04em; }
    .form-card { background:var(--card); border:1px solid rgba(255,255,255,0.03); padding:1rem; border-radius:10px; margin-top:1rem; }
    .form-row { display:flex; gap:.6rem; margin-bottom:.6rem; }
    .form-row input, .form-row select, .form-row textarea { flex:1; padding:.5rem .6rem; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; }
    .small-muted { color:var(--muted); font-size:.85rem; }
    .notice { margin-top:.6rem; color:var(--accent-2); font-weight:700; }
    .link { color:var(--accent); text-decoration:underline; cursor:pointer; }
    .center-row { display:flex; justify-content:center; gap:.5rem; align-items:center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <div class="container" style="display:flex;align-items:center;gap:1rem;justify-content:space-between;">
      <div>
        <a href="index.html" class="btn secondary" style="padding:.35rem .6rem;font-size:.9rem;">← Moda</a>
      </div>
      <div style="text-align:center;">
        <h1 id="song-title" style="margin:0.25rem 0;">Piosenka</h1>
        <p id="song-subtitle" class="text-muted" style="margin:0;">Ranking i zgłoszenia</p>
      </div>
      <div style="width:72px;"></div>
    </div>
  </header>

  <main class="container" role="main">
    <section class="song-header">
      <div class="song-meta" id="song-meta">
        <!-- dynamic meta: difficulty, verification, file -->
      </div>
    </section>

    <section aria-labelledby="ranking-heading">
      <h2 id="ranking-heading" style="margin:0 0 .5rem 0; font-size:1.1rem; color:var(--accent-2);">Ranking</h2>
      <div id="ranking-area">
        <div id="ranking-loading" class="small-muted">Ładowanie zgłoszeń...</div>
        <table id="submissions-table" class="submissions-table hidden" aria-live="polite">
          <thead>
            <tr>
              <th style="width:64px">#</th>
              <th>Gracz</th>
              <th>Accuracy</th>
              <th>Data</th>
              <th>Video</th>
              <th>Hz</th>
            </tr>
          </thead>
          <tbody id="submissions-body"></tbody>
        </table>
        <div id="no-submissions" class="small-muted hidden">Brak zgłoszeń dla tej piosenki.</div>
      </div>
    </section>

    <section aria-labelledby="submit-heading" style="margin-top:1.25rem;">
      <h2 id="submit-heading" style="margin:0 0 .5rem 0; font-size:1.1rem; color:var(--accent-2);">Zgłoś wynik</h2>

      <div class="form-card" id="submit-card">
        <form id="submit-form" novalidate>
          <div class="form-row">
            <input id="input-user" name="user" type="text" placeholder="Nick (np. Kuboiks)" required />
            <input id="input-accuracy" name="accuracy" type="number" step="0.01" placeholder="Accuracy (np. 99.82)" required />
          </div>

          <div class="form-row">
            <input id="input-video" name="video" type="url" placeholder="Link do filmu (YouTube)" required />
            <input id="input-hz" name="hz" type="text" placeholder="Hz (opcjonalnie)" />
          </div>

          <div class="form-row">
            <input id="input-misses" name="misses" type="number" min="0" placeholder="Misses (musi być 0)" required />
            <select id="input-platform" name="platform">
              <option value="">Platforma (opcjonalnie)</option>
              <option>PC</option>
              <option>Mobile</option>
              <option>Tablet</option>
            </select>
          </div>

          <div class="form-row">
            <textarea id="input-notes" name="notes" rows="2" placeholder="Notatki (opcjonalnie)"></textarea>
          </div>

          <div class="center-row" style="margin-top:.5rem;">
            <button type="submit" class="btn">Wyślij zgłoszenie</button>
            <button type="button" id="btn-clear" class="btn secondary">Wyczyść</button>
          </div>

          <div id="form-message" class="notice hidden" role="status"></div>
        </form>
      </div>
    </section>
  </main>

  <footer class="center" role="contentinfo" style="padding:1rem 0;">
    <small class="text-muted">Made by Kuboiks</small>
  </footer>

  <script>
    // Helpers
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function difficultyClass(diff) {
      if (!diff) return "badge medium";
      const d = diff.toLowerCase();
      if (d.includes("easy")) return "badge easy";
      if (d.includes("medium")) return "badge medium";
      if (d.includes("hard")) return "badge hard";
      if (d.includes("extreme") || d.includes("demon")) return "badge extreme";
      return "badge medium";
    }

    function normalizeSubmissions(data) {
      // Accept different shapes: submissions, records, or array at root
      const subs = data.submissions || data.records || data.entries || [];
      return subs.map(s => {
        return {
          user: s.user || s.player || s.name || s.nick || "Anon",
          accuracy: s.accuracy !== undefined ? Number(s.accuracy) : (s.percent !== undefined ? Number(s.percent) : null),
          link: s.link || s.video || s.url || "",
          date: s.date || s.timestamp || s.time || null,
          hz: s.hz || s.refresh || s.fps || "",
          misses: s.misses !== undefined ? Number(s.misses) : (s.miss !== undefined ? Number(s.miss) : null),
          notes: s.notes || s.note || ""
        };
      });
    }

    function sortSubmissions(subs) {
      return subs.slice().sort((a, b) => {
        const aAcc = a.accuracy || 0;
        const bAcc = b.accuracy || 0;
        if (bAcc !== aAcc) return bAcc - aAcc;
        const da = a.date ? new Date(a.date) : new Date(0);
        const db = b.date ? new Date(b.date) : new Date(0);
        return da - db;
      });
    }

    function formatDate(d) {
      if (!d) return "—";
      const dt = new Date(d);
      if (isNaN(dt)) return d;
      return dt.toLocaleString();
    }

    // Local storage key for user-submitted entries (client-side)
    function storageKey(mod, file) {
      return `ffl_subs_${mod}__${file}`;
    }

    // Load persisted submissions from localStorage
    function loadLocalSubs(mod, file) {
      try {
        const raw = localStorage.getItem(storageKey(mod, file));
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveLocalSubs(mod, file, arr) {
      try {
        localStorage.setItem(storageKey(mod, file), JSON.stringify(arr));
      } catch {}
    }

    // Main
    document.addEventListener("DOMContentLoaded", () => {
      const mod = getParam("mod");
      const file = getParam("file");
      const titleParam = getParam("title");

      const titleEl = document.getElementById("song-title");
      const subtitleEl = document.getElementById("song-subtitle");
      const metaEl = document.getElementById("song-meta");
      const loadingEl = document.getElementById("ranking-loading");
      const tableEl = document.getElementById("submissions-table");
      const bodyEl = document.getElementById("submissions-body");
      const noSubsEl = document.getElementById("no-submissions");
      const form = document.getElementById("submit-form");
      const msg = document.getElementById("form-message");
      const clearBtn = document.getElementById("btn-clear");

      if (!mod || !file) {
        titleEl.textContent = "Brak danych piosenki";
        loadingEl.textContent = "Nie podano moda lub pliku piosenki w URL.";
        return;
      }

      titleEl.textContent = decodeURIComponent(titleParam || file.replace('.json',''));
      subtitleEl.textContent = `${decodeURIComponent(mod)} • ranking`;

      // Fetch song JSON
      const songPath = `data/songs/${encodeURIComponent(mod)}/${encodeURIComponent(file)}`;
      fetch(songPath)
        .then(r => {
          if (!r.ok) throw new Error("Nie znaleziono pliku piosenki");
          return r.json();
        })
        .then(songData => {
          // Show meta
          const diff = songData.difficulty || songData.level || songData.diff || "";
          const ver = songData.verification || songData.verifier || songData.verificationVideo || songData.verification_link || "";
          const notes = songData.notes || songData.description || "";

          metaEl.innerHTML = "";
          const diffSpan = document.createElement("span");
          diffSpan.className = "meta-item";
          diffSpan.innerHTML = `<span class="${difficultyClass(diff)}" style="padding:.25rem .6rem; border-radius:999px;">${diff || "—"}</span>`;
          metaEl.appendChild(diffSpan);

          if (ver) {
            const verSpan = document.createElement("span");
            verSpan.className = "meta-item";
            verSpan.innerHTML = `Weryfikacja: <a class="link" href="${ver}" target="_blank" rel="noopener noreferrer">video</a>`;
            metaEl.appendChild(verSpan);
          }

          if (notes) {
            const notesSpan = document.createElement("span");
            notesSpan.className = "meta-item";
            notesSpan.textContent = notes;
            metaEl.appendChild(notesSpan);
          }

          // Normalize and combine submissions
          const fileSubs = normalizeSubmissions(songData);
          const localSubs = loadLocalSubs(mod, file);
          const allSubs = fileSubs.concat(localSubs);

          renderSubmissions(allSubs);
        })
        .catch(err => {
          loadingEl.textContent = "Błąd: " + err.message;
          tableEl.classList.add("hidden");
          noSubsEl.classList.remove("hidden");
        });

      function renderSubmissions(subs) {
        const normalized = subs.map(s => {
          // ensure types
          return {
            user: s.user || "Anon",
            accuracy: s.accuracy !== undefined && s.accuracy !== null ? Number(s.accuracy) : null,
            link: s.link || s.video || "",
            date: s.date || new Date().toISOString(),
            hz: s.hz || "",
            misses: s.misses !== undefined ? Number(s.misses) : null,
            notes: s.notes || ""
          };
        });

        const sorted = sortSubmissions(normalized);
        bodyEl.innerHTML = "";

        if (sorted.length === 0) {
          loadingEl.classList.add("hidden");
          tableEl.classList.add("hidden");
          noSubsEl.classList.remove("hidden");
          return;
        }

        sorted.forEach((s, idx) => {
          const tr = document.createElement("tr");

          const rankTd = document.createElement("td");
          rankTd.textContent = idx + 1;
          tr.appendChild(rankTd);

          const userTd = document.createElement("td");
          userTd.textContent = s.user;
          tr.appendChild(userTd);

          const accTd = document.createElement("td");
          accTd.textContent = s.accuracy !== null ? `${s.accuracy}%` : "—";
          tr.appendChild(accTd);

          const dateTd = document.createElement("td");
          dateTd.textContent = formatDate(s.date);
          tr.appendChild(dateTd);

          const videoTd = document.createElement("td");
          if (s.link) {
            const a = document.createElement("a");
            a.href = s.link;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "Oglądaj";
            a.className = "link";
            videoTd.appendChild(a);
          } else {
            videoTd.textContent = "—";
          }
          tr.appendChild(videoTd);

          const hzTd = document.createElement("td");
          hzTd.textContent = s.hz || "—";
          tr.appendChild(hzTd);

          bodyEl.appendChild(tr);
        });

        loadingEl.classList.add("hidden");
        tableEl.classList.remove("hidden");
        noSubsEl.classList.add("hidden");
      }

      // Form handling
      form.addEventListener("submit", (ev) => {
        ev.preventDefault();
        msg.classList.add("hidden");
        msg.textContent = "";

        const user = document.getElementById("input-user").value.trim();
        const accuracyRaw = document.getElementById("input-accuracy").value.trim();
        const video = document.getElementById("input-video").value.trim();
        const hz = document.getElementById("input-hz").value.trim();
        const misses = document.getElementById("input-misses").value.trim();
        const platform = document.getElementById("input-platform").value;
        const notes = document.getElementById("input-notes").value.trim();

        // Basic validation
        if (!user) return showFormMessage("Podaj nick gracza.");
        const accuracy = Number(accuracyRaw);
        if (isNaN(accuracy) || accuracy < 0 || accuracy > 100) return showFormMessage("Accuracy musi być liczbą od 0 do 100.");
        if (!video || (!video.includes("youtube.com") && !video.includes("youtu.be"))) return showFormMessage("Podaj poprawny link do YouTube.");
        const missesNum = misses === "" ? null : Number(misses);
        if (missesNum === null || isNaN(missesNum)) return showFormMessage("Podaj liczbę missów (0 jeśli brak).");
        if (missesNum !== 0) return showFormMessage("Zgłoszenie musi mieć 0 missów, aby zostać zaakceptowane.");

        // Create submission object
        const submission = {
          user,
          accuracy: Math.round(accuracy * 100) / 100,
          link: video,
          date: new Date().toISOString(),
          hz: hz || "",
          misses: missesNum,
          platform: platform || "",
          notes: notes || ""
        };

        // Persist locally and re-render
        const local = loadLocalSubs(mod, file);
        local.push(submission);
        saveLocalSubs(mod, file, local);

        // Update UI by fetching current table rows + new local
        // We will fetch original file again to combine; but simpler: append and re-render using existing table data
        const currentRows = Array.from(bodyEl.querySelectorAll("tr")).map(tr => {
          const tds = tr.querySelectorAll("td");
          return {
            user: tds[1].textContent,
            accuracy: parseFloat(tds[2].textContent) || null,
            link: (tds[4].querySelector("a") || {}).href || "",
            date: tds[3].textContent,
            hz: tds[5].textContent
          };
        });

        // Convert currentRows to normalized objects with ISO dates if possible
        const combined = currentRows.map(r => ({
          user: r.user,
          accuracy: r.accuracy,
          link: r.link,
          date: new Date(r.date).toISOString(),
          hz: r.hz
        })).concat(local);

        renderSubmissions(combined);

        showFormMessage("Zgłoszenie dodane lokalnie. Poczekaj na weryfikację.", true);
        form.reset();
        // Scroll to ranking
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      clearBtn.addEventListener("click", () => {
        form.reset();
        msg.classList.add("hidden");
      });

      function showFormMessage(text, success = false) {
        msg.textContent = text;
        msg.style.color = success ? "var(--accent-2)" : "var(--accent)";
        msg.classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
